name: Quote Duplicates Linter

on:
  pull_request_target:
    # Only run when quotes.json changes
    paths:
      - "quotes.json"

permissions:
  contents: read # for checkout
  issues: write # to post comments

jobs:
  check-duplicates:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout the PR‚Äôs head so we lint the contributor‚Äôs changes
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 2Ô∏è‚É£ Install Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      # 3Ô∏è‚É£ Install any deps your script needs
      - name: Install dependencies
        run: npm ci

      # 4Ô∏è‚É£ Run your duplicate-checker (capture its output‚Äîeven on error)
      - name: Run duplicate check
        id: dupes
        continue-on-error: true
        run: |
          set +e
          OUTPUT=$(node scripts/check-duplicates.js 2>&1)
          echo "$OUTPUT"
          # Write the full OUTPUT to the `result` output variable
          echo "result<<EOF" >> "$GITHUB_OUTPUT"
          echo "$OUTPUT"       >> "$GITHUB_OUTPUT"
          echo "EOF"           >> "$GITHUB_OUTPUT"

      # 5Ô∏è‚É£ If we found duplicates, post a comment on the PR
      - name: Comment on PR with duplicates
        if: contains( steps.dupes.outputs.result, '::duplicate-quotes-found::' )
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Grab the raw output from the previous step
            const raw = `\${{ steps.dupes.outputs.result }}`;
            // Everything after our marker is the list of dupes
            const dupText = raw.split('::duplicate-quotes-found::')[1]?.trim() || '';
            const body = '‚ö†Ô∏è Duplicate quotes detected in `quotes.json`:\n```' + dupText + '```\nPlease remove or reword them before merging.';
            await github.rest.issues.createComment({
              owner:         context.repo.owner,
              repo:          context.repo.repo,
              issue_number:  context.payload.pull_request.number,
              body
            });

      # 6Ô∏è‚É£ Finally, fail the job so the PR shows üî¥ until fixed
      - name: Fail on duplicates
        if: contains( steps.dupes.outputs.result, '::duplicate-quotes-found::' )
        run: |
          echo "::error::Duplicate quotes found‚Äîsee comment above."
          exit 1
